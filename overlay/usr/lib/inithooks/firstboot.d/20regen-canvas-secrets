#!/bin/bash -ex
# regenerate Canvas secrets

. /etc/default/inithooks

[ -e "$INITHOOKS_CONF" ] && . "$INITHOOKS_CONF"

WEBROOT='/var/www/canvas'

# security.yml
SECURITY="$WEBROOT/config/security.yml"

EKEY="$(mcookie)"
sed -i "s|\(encryption_key\): .*|\1: \"$EKEY\"|" $SECURITY

# vault_contents.yml
VAULT_CONTENTS="$WEBROOT/config/vault_contents.yml"

ECOSYSTEM_KEY="$(mcookie)"
ECOSYSTEM_SECRET="$(mcookie)"

sed -i "s|\(signing_secret\): .*|\1: \"$ECOSYSTEM_KEY\"|" "$VAULT_CONTENTS"
sed -i "s|\(encryption_secret\): .*|\1: \"$ECOSYSTEM_SECRET\"|" "$VAULT_CONTENTS"

# database.yml
DBCONFIG="$WEBROOT/config/database.yml"

DB_USER="$(grep -Po 'username: \K.*$' "$DBCONFIG")"
DB_NAME="$(grep -Po 'database: \K.*$' "$DBCONFIG")"
DB_PASS="$(mcookie)"

# db password
podman exec db psql -U "$DB_USER" "$DB_NAME" -c "ALTER USER $DB_USER WITH PASSWORD '$DB_PASS';"
sed -i "s|\(password\): .*$|\1: $DB_PASS|" "$DBCONFIG"

# canvas-rce-api
export ECOSYSTEM_KEY ECOSYSTEM_SECRET

# the STATSD_ envvars are useless but it won't run without them
podman create \
  --replace \
  --pod canvas-pod \
  --restart always \
  --name canvas-rce-api \
  -e 'CG_HTTP_PORT=3000' \
  -e 'CG_HTTPS_PORT=3000' \
  -e ECOSYSTEM_KEY \
  -e ECOSYSTEM_SECRET \
  -e STATSD_HOST=127.0.0.1 \
  -e STATSD_PORT=8125 \
  instructure/canvas-rce-api

WWW='/var/www/canvas'
CFG_VOLUME="$WWW/config:/usr/src/app/config:U"

podman run --rm --pod canvas-pod -v "$CFG_VOLUME" canvas bundle exec rake db:reset_encryption_key_hash
podman create --pod canvas-pod --restart always --replace --name canvas -v "$CFG_VOLUME" -e 'CG_HTTP_PORT=8080' -e 'CG_HTTPS_PORT=8080' canvas
podman pod start canvas-pod
